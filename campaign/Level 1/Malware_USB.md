# USB Malware - Level 1 Scenario

> **Category:** Malware  
> **Subcategory:** USB-Based Attack  
> **Difficulty:** Level 1 (Fundamentals)  
> **Events:** 2

---

## Scenario Description

A workstation in the Finance department generated an external device recognition event when a USB drive was connected, followed by a process creation event showing an executable running directly from the USB drive path. Review the Windows Security and Sysmon logs and determine if these events represent a malware infection via USB.

---

## Attack Pattern Reference

| Framework | ID | Name | Link |
|-----------|-----|------|------|
| MITRE ATT&CK | **T1091** | Replication Through Removable Media | [attack.mitre.org](https://attack.mitre.org/techniques/T1091/) |
| MITRE ATT&CK | **T1204.002** | User Execution: Malicious File | [attack.mitre.org](https://attack.mitre.org/techniques/T1204/002/) |
| ATT&CK Tactic | **TA0001** | Initial Access | |
| ATT&CK Tactic | **TA0002** | Execution | |
| CAPEC | **CAPEC-457** | USB Memory Attacks | [capec.mitre.org](https://capec.mitre.org/data/definitions/457.html) |

---

## Log Events

### Event 1 of 2 — USB Storage Device Connected

#### Table View

| TIME | EVENT TYPE | LOG SOURCE | SOURCE IP | DEST IP | PROTOCOL | MESSAGE |
|------|------------|------------|-----------|---------|----------|---------|
| 14:32:18 | 6416 | Windows Security | | | | `A new external device was recognized. Subject: Security ID: S-1-5-21-xxx-1001 Account Name: jsmith Account Domain: CORP Logon ID: 0x5E6F70 Device ID: USBSTOR\DISK&VEN_SANDISK&PROD_CRUZER_BLADE&REV_1.00\4C530001234567890&0 Device Name: SanDisk Cruzer Blade USB Device Class Name: DiskDrive Class ID: {4d36e967-e325-11ce-bfc1-08002be10318}` |

#### Expanded Key Value Pairs

```
event_id = 6416
subject_user = jsmith
subject_domain = CORP
logon_id = 0x5E6F70
device_id = USBSTOR\DISK&VEN_SANDISK&PROD_CRUZER_BLADE&REV_1.00\4C530001234567890&0
device_name = SanDisk Cruzer Blade USB Device
class_name = DiskDrive
class_id = {4d36e967-e325-11ce-bfc1-08002be10318}
compatible_ids = USBSTOR\Disk;USBSTOR\RAW
location = Port_#0002.Hub_#0001
host = ACME-WS14
```

---

### Event 2 of 2 — Executable Runs From USB Drive Path

#### Table View

| TIME | EVENT TYPE | LOG SOURCE | SOURCE IP | DEST IP | PROTOCOL | MESSAGE |
|------|------------|------------|-----------|---------|----------|---------|
| 14:33:41 | ProcessCreate | Sysmon | 10.0.1.14 | | | `Process Create: UtcTime=2026-01-27 14:33:41.208 ProcessGuid={F81B2C04-DA29-5903-0000-00103BEA4E33} ProcessId=7412 Image=E:\setup.exe CommandLine="E:\setup.exe" User=CORP\jsmith ParentImage=C:\Windows\explorer.exe ParentCommandLine=C:\Windows\explorer.exe ParentProcessId=3284` |

#### Expanded Key Value Pairs

```
event_id = 1
event_type = ProcessCreate
utc_time = 2026-01-27 14:33:41.208
process_guid = {F81B2C04-DA29-5903-0000-00103BEA4E33}
process_id = 7412
image = E:\setup.exe
command_line = "E:\setup.exe"
user = CORP\jsmith
parent_image = C:\Windows\explorer.exe
parent_command_line = C:\Windows\explorer.exe
parent_process_id = 3284
integrity_level = Medium
host = ACME-WS14
hashes = SHA256=9F3C2E7A1B5D4F8E6A0C3B7D9E1F4A6C8B2D5E7F0A3C6B8D1E4F7A9C2B5D8E01
```

---

## Expected Answer

**Classification:** Malicious - Malware (USB-Based Attack)

**Threat Category:** Malware / Initial Access via Removable Media

---

## Triage Review

### What is it?

A **USB malware attack** occurs when an adversary loads malicious software onto a USB drive, and the malware executes when the drive is connected to a target system. In this scenario, jsmith connected a USB drive and an unknown executable (`setup.exe`) ran directly from the USB drive path (`E:\`).

This is a confirmed malware execution because:
- An executable ran from a removable media path — legitimate software doesn't run from USB drives in a corporate environment
- The file name `setup.exe` is generic and commonly used by malware to appear trustworthy
- The user double-clicked the file (parent: `explorer.exe`) — social engineering succeeded
- The workstation is in the Finance department with access to sensitive data

| Indicator | What It Means | Why It's Suspicious |
|-----------|---------------|---------------------|
| **Event 6416: USB DiskDrive inserted** | Removable storage device connected | Policy violation — Finance systems prohibit removable media |
| **`E:\setup.exe` executed** | An executable ran from the USB drive | Code executing from removable media is a primary malware delivery method |
| **Image path: `E:\`** | Process running from removable drive letter | Legitimate corporate software runs from `C:\Program Files`, not removable drives |
| **Filename: `setup.exe`** | Generic installer name | Malware frequently uses trusted-sounding names like `setup.exe`, `install.exe`, `update.exe` |
| **Parent: `explorer.exe`** | User double-clicked the file | Social engineering — user was tricked into running the executable |
| **~83 seconds between insertion and execution** | User browsed USB contents and opened the file | Manual execution — user found and clicked the file |

### Understanding the Attack

```
STEP 1: USB drive inserted (14:32:18)
   │
   ├── Windows recognizes SanDisk Cruzer Blade
   ├── Drive letter E:\ assigned
   └── Windows Security logs Event 6416 → Event 1
          │
          STEP 2: User opens USB in File Explorer
          │
          ├── jsmith browses to E:\
          ├── Sees setup.exe (may have a convincing icon — installer, document, etc.)
          └── Double-clicks setup.exe
               │
               STEP 3: Malware executes (14:33:41)
               │
               ├── explorer.exe spawns E:\setup.exe
               └── Sysmon logs ProcessCreate → Event 2
                    │
                    └── NEXT (not seen): malware establishes persistence, contacts C2, etc.
```

### The Key Indicator: Execution Path

The most important field in Event 2 is the **image path**:

```
image = E:\setup.exe
```

| Drive Letter | What It Typically Means |
|-------------|------------------------|
| `C:\` | Local hard drive — operating system and installed software |
| `D:\` | Secondary drive or CD/DVD |
| `E:\`, `F:\`, `G:\` | Removable media — USB drives, external hard drives |
| `\\server\share` | Network share — mapped drives |

An executable running from `E:\` means it's running **directly from the USB drive**. Legitimate corporate software is installed to `C:\Program Files` or deployed via management tools. Executables running from removable drive letters are a primary indicator of USB-based malware.

### Common USB Malware Disguises (Reference)

| Filename | Why Attackers Use It |
|----------|---------------------|
| **setup.exe** (this scenario) | Looks like a software installer — users expect to run it |
| **autorun.exe** | Executes automatically on older Windows versions |
| **resume.pdf.exe** | Double extension trick — appears to be a PDF |
| **photos.exe** | Appears to be a photo viewer application |
| **document.scr** | Screensaver file that's actually executable |
| **shortcut.lnk** | Shortcut file that points to hidden malware |

### How USB Malware Spreads (Reference)

| Method | How It Works | Windows Version |
|--------|-------------|----------------|
| **AutoRun** | USB contains `autorun.inf` that launches malware automatically | Windows XP/Vista (disabled by default in Win 7+) |
| **Social Engineering** (this scenario) | User manually opens and runs the executable | All versions |
| **Shortcut Exploit** | Malicious `.lnk` file executes code when folder is viewed | CVE-2010-2568 (Stuxnet) |
| **DMA Attack** | USB device directly accesses system memory | Hardware-dependent |
| **BadUSB** | USB firmware reprogrammed to emulate keyboard and type commands | All versions |

### Attack Context

USB malware attacks (T1091) exploit the physical trust between a system and connected devices. Adversaries use USB drives to:

- **Bypass perimeter security** — malware enters via physical media, not the network. Firewalls and proxies never see it
- **Target air-gapped networks** — systems intentionally disconnected from the internet can only be reached via physical media
- **Leverage social engineering** — USB drop attacks (leaving infected drives in parking lots, lobbies) trick users into plugging them in
- **Deliver targeted payloads** — a USB left specifically for a target employee can carry customized malware
- **Exploit trust** — users trust physical devices more than email attachments

### Real-World Examples

| Malware / Campaign | How USB Was Used |
|-------------------|-----------------|
| **Stuxnet (2010)** | USB drives carried the worm into air-gapped Iranian nuclear centrifuge control systems |
| **Agent.BTZ (2008)** | Infected USB drive left in a US military facility parking lot compromised classified networks |
| **USBferry** | Tropic Trooper APT campaign used USB drives to bridge air-gapped military networks |
| **PlugX** | Chinese APT malware with USB replication — copies itself to any connected USB drive |
| **Raspberry Robin (2022)** | Malicious `.lnk` files on USB drives spread worm across enterprise networks |
| **ANDROMEDA (2022)** | Russian-linked campaign used infected USB drives to target Ukrainian organizations |

### MITRE ATT&CK Context

**Technique T1091 - Replication Through Removable Media**

> "Adversaries may move onto systems, possibly those on disconnected or air-gapped networks, by copying malware to removable media and taking advantage of Autorun features when the media is inserted into a system and executes."

**Detection Focus:**
- Monitor for processes executing from removable drive paths (`E:\`, `F:\`, `G:\`)
- Correlate USB insertion events (6416) with subsequent process creation on the same host
- Track executable files accessed on removable media
- Look for subsequent network connections from processes launched from USB paths
- Monitor for discovery and reconnaissance commands after USB-launched execution

---

## Recommended Response Actions

### Immediate Actions
1. **Isolate the workstation** (ACME-WS14) — disconnect from network immediately; malware is active
2. **Do NOT remove the USB** — preserve the device as forensic evidence
3. **Kill the process** — terminate `setup.exe` (PID 7412) if still running

### Investigation Steps
4. **Analyze the executable** — submit the SHA256 hash (`9F3C2E...`) to VirusTotal and run in a sandbox
5. **Check for post-execution activity** — review Sysmon logs on ACME-WS14 for any activity spawned by `setup.exe` (network connections, file drops, registry changes, persistence mechanisms)
6. **Determine USB origin** — interview jsmith about where the USB came from (found it, received it, personal device)
7. **Scope the attack** — search for the same USB device serial number (`4C530001234567890`) and file hash across all workstations

### Remediation
8. **Clean the workstation** — remove all artifacts created by `setup.exe` (dropped files, registry keys, scheduled tasks)
9. **Reset credentials** — assume jsmith's credentials are compromised
10. **Quarantine the USB** — secure the device for forensic analysis in an isolated environment

### Post-Incident
11. **Document findings** — create incident report covering the USB malware delivery and any post-compromise activity
12. **Enforce USB controls** — implement device control policies via GPO or endpoint agent to block unauthorized USB storage devices
13. **User awareness** — train employees to never insert unknown USB devices and to report found devices to IT/Security

---

## Log Authenticity Notes

### Event 1 — Windows Security 6416

| Field | Value | Why It's Realistic |
|-------|-------|-------------------|
| `event_id=6416` | Correct Windows Security event for PnP device recognition (requires "Audit PnP Activity" enabled) |
| `device_name=SanDisk Cruzer Blade` | Common consumer USB drive — widely available, not corporate-issued |
| `class_name=DiskDrive` | Removable storage device class — confirms this is a USB storage device |
| `class_id={4d36e967-e325-11ce-bfc1-08002be10318}` | Actual Windows GUID for DiskDrive device class |
| `USBSTOR\DISK&VEN_SANDISK...` | Real Windows device instance path format with unique serial |
| `compatible_ids=USBSTOR\Disk;USBSTOR\RAW` | How Windows identifies generic USB storage drivers |
| `location=Port_#0002.Hub_#0001` | Physical USB port location identifier |

### Event 2 — Sysmon ProcessCreate

| Field | Value | Why It's Realistic |
|-------|-------|-------------------|
| `image=E:\setup.exe` | Executable running from removable drive letter — primary USB malware indicator |
| `command_line="E:\setup.exe"` | No arguments — user double-clicked, didn't run from command line |
| `parent_image=explorer.exe` | File Explorer spawned the process — user manually opened it |
| `user=CORP\jsmith` | Same user who inserted the USB — consistent identity |
| `host=ACME-WS14` | Same workstation as the USB insertion — consistent host |
| `integrity_level=Medium` | User-level — no UAC elevation prompt accepted |
| `~83 second gap` | Time for USB to mount, user to browse, find file, and double-click |

### Legitimate vs Malicious Comparison

| Legitimate USB Use | USB Malware (This Scenario) |
|-------------------|---------------------------|
| USB contains documents, presentations, photos | USB contains an executable file |
| No executables on the drive | `setup.exe` runs from the USB path |
| Files are opened by installed applications (Word, Excel) | File IS the application — it runs itself |
| Corporate-issued encrypted USB | Personal consumer USB (SanDisk Cruzer Blade) |
| IT-approved file transfer | No approval or documentation |
| Files copied to local drive, then opened | Executable runs directly from USB |

---

## Cross-Log Correlation Guide

### How the Two Events Connect

```
Timeline on ACME-WS14:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
14:32:18  ─── Windows Security 6416 ─── SanDisk Cruzer Blade USB inserted by jsmith
    │
    │  ~83 seconds (USB mounts as E:\, user browses, finds setup.exe, double-clicks)
    │
14:33:41  ─── Sysmon ProcessCreate ─── E:\setup.exe executes (parent: explorer.exe)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
```

### Correlation Anchors

| Anchor Point | Event 1 (Windows Security) | Event 2 (Sysmon) |
|-------------|---------------------------|-------------------|
| **User** | `subject_user=jsmith` | `user=CORP\jsmith` |
| **Host** | `host=ACME-WS14` | `host=ACME-WS14` |
| **Device → Path** | USB DiskDrive inserted → assigned `E:\` | `image=E:\setup.exe` — runs from USB path |
| **Time Proximity** | `14:32:18` | `14:33:41` (83 sec later) |
| **Logon Session** | `logon_id=0x5E6F70` | Same user session |

### Why Both Events Are Needed

| Event Alone | Why It's Incomplete |
|-------------|-------------------|
| **6416 USB insertion only** | USB drives are plugged in for many reasons — file transfers, charging devices, presentations. Without seeing what happened next, this is just a policy violation, not confirmed malware |
| **Sysmon ProcessCreate only** | A process running from `E:\` could theoretically be a legitimate portable application. But combined with the USB insertion on a policy-restricted Finance workstation, it's confirmed USB malware execution |
| **Together** | USB inserted → executable runs from USB path 83 seconds later = malware delivered and executed via removable media. The device event confirms the source, the process event confirms the execution |

---

## Level Progression Preview

| Level | Events | Complexity |
|-------|--------|------------|
| **Level 1** (Current) | 2 | USB insertion + malware execution from USB path |
| **Level 2** | 3-4 | Add file drops, persistence mechanisms |
| **Level 3** | 2 | USB exfiltration — same 6416 event, opposite classification (data going OUT) |

---

## Related Log Sources

For more advanced scenarios, USB malware can be detected across multiple sources:

| Log Source | Event Type | What It Shows |
|------------|------------|---------------|
| **Windows Security 6416** | New External Device | USB drive connected to workstation (this scenario) |
| **Sysmon Event 1** | ProcessCreate | Executable running from USB drive path (this scenario) |
| **Sysmon Event 11** | FileCreate | Malware dropping files to local disk from USB |
| **Sysmon Event 13** | RegistryEvent | Persistence via Run key or service registration |
| **Sysmon Event 3** | NetworkConnection | Post-execution C2 connection from USB-launched malware |
| **Windows Security 6419** | Device Disabled | USB device blocked by policy |
| **Windows Security 4688** | Process Creation | Corroborating process creation from Windows audit logs |

---

## Detection Rule Logic (Reference)

```
# Windows Security: USB device insertion on restricted hosts
MATCH windows_security_logs WHERE
  event_id = 6416
  AND class_name = "DiskDrive"
  AND host IN finance_workstations
  AND device_id NOT IN corporate_approved_usb_devices

# Sysmon: Process execution from removable media
MATCH sysmon_logs WHERE
  event_type = "ProcessCreate"
  AND (
    image MATCHES "E:\\*.exe" OR
    image MATCHES "F:\\*.exe" OR
    image MATCHES "G:\\*.exe"
  )

# Correlation: USB insertion followed by execution from USB path
MATCH windows_security_logs AS usb
  JOIN sysmon_logs AS exec
  ON usb.host = exec.host
  AND usb.subject_user = exec.user
  AND exec.utc_time BETWEEN usb.event_time AND usb.event_time + 300s
WHERE
  usb.event_id = 6416
  AND usb.class_name = "DiskDrive"
  AND exec.event_type = "ProcessCreate"
  AND exec.image MATCHES "[D-Z]:\\*.exe"
```

---

## Common False Positives

Understanding legitimate scenarios helps avoid alert fatigue:

| False Positive Scenario | How to Identify |
|-------------------------|-----------------|
| IT technician running portable diagnostic tool from USB | IT staff account, known IT USB device, documented maintenance |
| Employee running portable application (Notepad++, PuTTY portable) | Known portable app hash, non-sensitive workstation |
| USB bootable media for system recovery | IT admin account, during maintenance window |
| Vendor technician using USB-based configuration tool | Documented vendor visit, escorted access |

**Key Differentiators:**
- Legitimate: IT/admin account, known tool, documented purpose, approved device
- Malicious: Standard user, unknown executable, no documentation, personal USB, Finance workstation

---

## Process Chain Analysis

### Suspicious Chain (This Scenario)
```
[ACME-WS14] explorer.exe (jsmith browses USB in File Explorer)
  └── E:\setup.exe (MALWARE — unknown executable from USB)
      └── NEXT: file drops, persistence, C2 connection...
```
**Why Suspicious:** Unknown executable running from removable media path on a Finance workstation, launched by user double-click

### Legitimate Chain (IT Portable Tool)
```
[ACME-WS14] explorer.exe (IT admin browses approved USB)
  └── E:\PortableTools\WinDirStat.exe (known portable utility)
      └── Displays disk usage — documented maintenance task
```
**Why Legitimate:** Known tool with verified hash, IT admin account, documented purpose, approved USB device

---

## Event ID Reference

| Event ID | Description | Detection Value |
|----------|-------------|-----------------|
| 6416 | New external device recognized | USB / removable media insertion |
| 6419 | Device disabled | Device blocked by policy |
| 6420 | Device enabled | Device allowed after block |
| 6421 | Request to enable device | User attempted to enable blocked device |
| Sysmon 1 | Process created | Execution from removable media path |
| Sysmon 11 | File created | Malware dropping payload to local disk |
| Sysmon 13 | Registry value set | Persistence mechanism installed |

---

*Last Updated: January 2026*  
*Spectyr Training Platform*
