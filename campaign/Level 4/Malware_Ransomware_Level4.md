# Malware (Ransomware) - Level 4 Scenario

> **Category:** Malware  
> **Subcategory:** Ransomware: File Encryption for Extortion  
> **Difficulty:** Level 4 (Multi-Stage Analysis)  
> **Events:** 3

---

## Scenario Description

A Sysmon alert shows a process named `svchost.exe` launching from an unusual directory with encryption-related command-line arguments. Shortly after, critical business files begin appearing with a `.locked` extension, followed by a ransom note being dropped on the user's Desktop. Review the Sysmon logs and determine if these events represent a ransomware attack.

---

## Attack Pattern Reference

| Framework | ID | Name | Link |
|-----------|-----|------|------|
| MITRE ATT&CK | **T1486** | Data Encrypted for Impact | [attack.mitre.org](https://attack.mitre.org/techniques/T1486/) |
| MITRE ATT&CK | **T1036.005** | Masquerading: Match Legitimate Name or Location | [attack.mitre.org](https://attack.mitre.org/techniques/T1036/005/) |
| ATT&CK Tactic | **TA0040** | Impact | |
| ATT&CK Tactic | **TA0005** | Defense Evasion | |

> **Note:** T1486 is the signature MITRE technique for ransomware. T1036.005 covers the use of `svchost.exe` as a process name in a non-standard location to evade detection.

---

## Log Events

### Event 1 of 3 — Ransomware Process Launches from Temp Directory

#### Table View

| TIME | EVENT TYPE | SOURCE TYPE | SOURCE IP | DEST IP | MESSAGE |
|------|------------|-------------|-----------|---------|---------|
| {timestamp_1} | ProcessCreate | Sysmon | {src_ip} | — | Process created: svchost.exe by {user_domain}. |

#### Key Value Pairs

```
timestamp = {timestamp_1}
event_type = ProcessCreate
source_type = Sysmon
host = {hostname}
src_ip = {src_ip}
image = C:\Users\{username}\AppData\Local\Temp\svchost.exe
commandline = svchost.exe -encrypt -ext .locked -path C:\Users\{username}\Documents
user = {user_domain}
parent_image = C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe
process_id = 18204
message = Process created: svchost.exe by {user_domain}.
```

---

### Event 2 of 3 — Critical Business File Encrypted

#### Table View

| TIME | EVENT TYPE | SOURCE TYPE | SOURCE IP | DEST IP | MESSAGE |
|------|------------|-------------|-----------|---------|---------|
| {timestamp_2} | FileCreate | Sysmon | {src_ip} | — | File created: ACME_Client_Contracts_2026.pdf.locked by {user_domain}. |

#### Key Value Pairs

```
timestamp = {timestamp_2}
event_type = FileCreate
source_type = Sysmon
host = {hostname}
src_ip = {src_ip}
image = C:\Users\{username}\AppData\Local\Temp\svchost.exe
target_filename = C:\Users\{username}\Documents\ACME_Client_Contracts_2026.pdf.locked
user = {user_domain}
process_id = 18204
message = File created: ACME_Client_Contracts_2026.pdf.locked by {user_domain}.
```

---

### Event 3 of 3 — Ransom Note Dropped to Desktop

#### Table View

| TIME | EVENT TYPE | SOURCE TYPE | SOURCE IP | DEST IP | MESSAGE |
|------|------------|-------------|-----------|---------|---------|
| {timestamp_3} | FileCreate | Sysmon | {src_ip} | — | File created: DECRYPT_YOUR_FILES.txt by {user_domain}. |

#### Key Value Pairs

```
timestamp = {timestamp_3}
event_type = FileCreate
source_type = Sysmon
host = {hostname}
src_ip = {src_ip}
image = C:\Users\{username}\AppData\Local\Temp\svchost.exe
target_filename = C:\Users\{username}\Desktop\DECRYPT_YOUR_FILES.txt
user = {user_domain}
process_id = 18204
message = File created: DECRYPT_YOUR_FILES.txt by {user_domain}.
```

---

## Expected Answer

**Classification:** Malicious - Ransomware

**Threat Category:** File Encryption for Extortion (Data Encrypted for Impact)

---

## Triage Review

### What is it?

**Ransomware** is malware that encrypts a victim's files and demands payment — usually in cryptocurrency — in exchange for the decryption key. Unlike other malware that steals data quietly, ransomware is loud on purpose. The attacker wants the victim to know they've been hit because the whole operation depends on the victim paying.

In this scenario, a process masquerading as `svchost.exe` launched from a Temp directory, encrypted critical business files, and dropped a ransom note on the Desktop. By the time the ransom note appears, the damage is done — files are already locked.

| Indicator | What It Means | Why It's Suspicious |
|-----------|---------------|---------------------|
| **`svchost.exe` in `AppData\Local\Temp\`** | Process name matches a real Windows service | Real svchost.exe lives in `C:\Windows\System32\` — never in Temp. This is masquerading (T1036.005). |
| **`parent_image = powershell.exe`** | Launched by PowerShell | Real svchost.exe is launched by `services.exe` — PowerShell launching it means something scripted delivered this payload |
| **`-encrypt -ext .locked`** | Command line shows encryption flags | Legitimate svchost never has these arguments — this is the ransomware's operational parameters |
| **`.locked` extension appended** | Original file encrypted with new extension | `ACME_Client_Contracts_2026.pdf.locked` — the original file is now unreadable |
| **Critical business files targeted** | Client contracts encrypted | Ransomware targets high-value files to maximize pressure to pay |
| **`DECRYPT_YOUR_FILES.txt` on Desktop** | Ransom note dropped to visible location | Confirms ransomware — typically contains payment instructions and a Bitcoin wallet address |
| **Same PID across all events** | process_id 18204 in every event | One process did everything — encryption and ransom note are the same malware |
| **Rapid timing** | Events span less than 60 seconds | Ransomware works fast to encrypt as much as possible before anyone can respond |

### Understanding the Ransomware Chain

```
PRIOR (not visible in these logs):
  Malware delivered via phishing, trojan, or exploit
  PowerShell downloads and executes the payload
       │
       ▼
EVENT 1: Ransomware process starts ({timestamp_1})
   │
   ├── svchost.exe launches from AppData\Local\Temp\
   ├── Parent is powershell.exe — scripted delivery
   ├── Command line reveals: -encrypt -ext .locked
   └── Masquerading as legitimate Windows process
          │
          EVENT 2: File encryption begins (~30-45s later)
          │
          ├── Same process (PID 18204) encrypts files
          ├── Targets Documents folder — business-critical data
          └── Appends .locked extension to every file
               │
               EVENT 3: Ransom note dropped (~10-15s later)
               │
               ├── Same process writes DECRYPT_YOUR_FILES.txt
               ├── Dropped to Desktop for maximum visibility
               └── Contains payment demands — attack is complete
```

### Why `svchost.exe` in Temp is a Critical Red Flag

Real `svchost.exe` is one of the most important Windows processes — it hosts system services like Windows Update, DNS Client, and DHCP. Attackers name their malware `svchost.exe` because analysts and users see it constantly in Task Manager and learn to ignore it.

The key to catching this is **knowing where the real one lives:**

| | Real svchost.exe | This svchost.exe |
|---|---|---|
| **Path** | `C:\Windows\System32\svchost.exe` | `C:\Users\{username}\AppData\Local\Temp\svchost.exe` |
| **Parent** | `services.exe` | `powershell.exe` |
| **Arguments** | `-k netsvcs -p -s ServiceName` | `-encrypt -ext .locked -path Documents` |
| **User context** | SYSTEM or LOCAL SERVICE | Regular user account |
| **Behavior** | Hosts Windows services quietly | Encrypts files and drops ransom notes |

A SOC analyst who knows the normal svchost parent chain (`services.exe → svchost.exe`) immediately flags this. Wrong path + wrong parent + wrong arguments = malware masquerading as a system process.

### How Ransomware Encrypts Files

Ransomware typically uses a hybrid encryption approach for speed and security:

| Step | What Happens |
|------|-------------|
| **1. Generate key** | Ransomware generates a unique symmetric encryption key (AES or ChaCha20) for the victim machine |
| **2. Encrypt files** | Uses the symmetric key to rapidly encrypt every targeted file — documents, spreadsheets, PDFs, images, source code |
| **3. Protect the key** | Encrypts the symmetric key with the attacker's public RSA key — only the attacker's private key can decrypt it |
| **4. Rename files** | Appends an extension (`.locked`, `.encrypted`, `.ryuk`, etc.) so the victim sees the damage |
| **5. Drop ransom note** | Places a text file with payment instructions on the Desktop and/or in every encrypted folder |
| **6. Delete backups** | Advanced ransomware also deletes shadow copies and local backups to prevent free recovery |

### Common Ransomware Indicators in Logs

| Log Source | What to Look For |
|------------|-----------------|
| **Sysmon ProcessCreate** | Unexpected executables in Temp/AppData, encryption-related command-line arguments, PowerShell or cmd.exe as parent for unknown binaries |
| **Sysmon FileCreate** | Mass file creation with new extensions (.locked, .encrypted, .crypt), ransom notes (DECRYPT, README, RESTORE, RECOVER) |
| **Sysmon Event 1** | Processes deleting shadow copies: `vssadmin.exe delete shadows /all /quiet` |
| **Windows Security 4688** | Corroborating process creation events |
| **Firewall/Proxy** | Outbound connections from the ransomware process — C2 callback sending the encryption key to the attacker |

### Real-World Ransomware Families

| Family | Known For |
|--------|-----------|
| **LockBit** | Fastest encryption speed, ransomware-as-a-service model, dominant in 2023-2024 |
| **BlackCat/ALPHV** | Written in Rust, cross-platform (Windows + Linux), double extortion |
| **Conti** | Targeted healthcare and critical infrastructure, leaked internal chats in 2022 |
| **REvil/Sodinokibi** | Supply chain attacks (Kaseya), demanded $70M in one attack |
| **WannaCry** | Used EternalBlue exploit to self-propagate, hit 200,000+ machines in 2017 |
| **Ryuk** | Targeted large organizations, average ransom demand over $1M |

---

## Recommended Triage Steps

### 1. IMMEDIATE — Isolate the Host
Pull the affected workstation off the network. Ransomware can spread laterally via SMB shares. Every second connected is another machine at risk. Do not shut it down — isolate it. The encryption keys may still be in memory.

### 2. Identify the Scope
Search the SIEM for other hosts showing the same indicators:
- Any other `svchost.exe` processes running from `AppData\Local\Temp\`
- Any other FileCreate events with `.locked` extensions
- Any other hosts with PowerShell launching unexpected executables
- Check network shares — did the ransomware reach shared drives?

### 3. Preserve Evidence
Capture a memory dump of the affected workstation before any remediation. The encryption key may be recoverable from memory. Snapshot the disk. Save all relevant logs.

### 4. Trace the Delivery Method
Work backwards — how did `svchost.exe` get into Temp?
- Check Proxy logs for recent downloads to this workstation
- Check Sysmon FileCreate for when `svchost.exe` was written to Temp
- Check PowerShell logs for the script that launched it
- Check email logs if phishing is suspected

### 5. Block the Indicators
- Hash the malicious `svchost.exe` and block it across all endpoints via EDR
- Block the PowerShell execution pattern that delivered it
- If a download source is found, block that domain/IP at the firewall and proxy

### 6. Assess the Damage
- Which files were encrypted? Are backups available and clean?
- Was any data exfiltrated before encryption? (double extortion)
- How many hosts are affected?
- Can operations continue or is this a business continuity event?

### 7. Escalate
Ransomware is never a Tier 1 close-and-move-on alert. Escalate to incident response team, notify management, and engage legal if data was exfiltrated. Do not pay the ransom without executive and legal approval — payment does not guarantee recovery and may violate regulations.

---

## Generation Rules

| Variable | Rule |
|----------|------|
| {src_ip} | Same across all 3 events |
| {hostname} | Same across all 3 events |
| {username} | Same across all 3 events |
| {user_domain} | ACME\\{username} |
| process_id | 18204 across all 3 events — same process doing everything |
| {timestamp_1} → {timestamp_2} | ~30-45 second gap (encryption starts fast) |
| {timestamp_2} → {timestamp_3} | ~10-15 second gap (ransom note drops right after) |
| Timestamps | Business hours — ransomware hits when users are active for maximum disruption |

---

## What the Player Should Recognize

| Indicator | Evidence |
|-----------|----------|
| `svchost.exe` in wrong location | Real svchost lives in `C:\Windows\System32\`, not `AppData\Local\Temp\` |
| `parent_image = powershell.exe` | Real svchost is launched by `services.exe` — PowerShell launching it is never normal |
| `-encrypt -ext .locked` in command line | Encryption flags explicitly reveal ransomware intent |
| `.pdf.locked` extension | Original file encrypted with new extension appended |
| `DECRYPT_YOUR_FILES.txt` on Desktop | Classic ransom note placement for maximum visibility |
| Same PID across all 3 events | 18204 — one process created the encrypted files and the ransom note |
| Same `image` path in Events 2 and 3 | The fake svchost.exe in Temp is the process creating both encrypted files and the ransom note |
| Rapid timing between events | Less than 60 seconds from process start to ransom note — automated, not human |

### The Level 4 Difficulty Factor

Level 4 requires the player to recognize **masquerading** combined with **destructive behavior** across multiple Sysmon event types:

| Stage | What the Player Must Recognize | Difficulty |
|-------|-------------------------------|------------|
| **1. Masquerading** | `svchost.exe` is a real Windows process but is running from the wrong path with the wrong parent — requires knowing normal Windows process chains | High |
| **2. Encryption Activity** | A `.locked` extension on a business file means encryption, not just file creation — requires understanding ransomware behavior patterns | Medium |
| **3. Ransom Note** | `DECRYPT_YOUR_FILES.txt` on Desktop confirms ransomware — the easiest indicator but only meaningful in context of Events 1 and 2 | Low |
| **4. PID Correlation** | Same process_id (18204) across all three events proves one process did everything — requires tracing process activity across event types | Level 4 skill |

---

## Level Progression Preview

| Level | Events | Complexity |
|-------|--------|------------|
| **Level 1** | 1 | Single event — Suspicious process or file extension |
| **Level 2** | 2 | Two events — Encryption activity + ransom note (clear indicators) |
| **Level 3** | 3 | Three events — Process launch + encryption + note (context-heavy) |
| **Level 4** (Current) | 3 | Three events — Masquerading process + encryption + ransom note (requires Windows process knowledge + PID correlation + behavioral analysis) |

---

## Related Log Sources

For more advanced scenarios, ransomware can be detected across multiple sources:

| Log Source | Event Type | What It Shows |
|------------|------------|---------------|
| **Sysmon Event 1** | ProcessCreate | Ransomware executable launch with command-line arguments (this scenario) |
| **Sysmon Event 11** | FileCreate | Encrypted file creation and ransom note deployment (this scenario) |
| **Sysmon Event 1** | ProcessCreate | Shadow copy deletion: `vssadmin.exe delete shadows /all /quiet` |
| **Sysmon Event 13** | RegistryEvent | Persistence mechanisms written by ransomware |
| **Sysmon Event 3** | NetworkConnection | C2 callback sending encryption key to attacker |
| **Windows Security 4688** | Process Creation | Corroborating process creation from Windows audit logs |
| **Firewall ALLOW** | Outbound HTTPS | Ransomware exfiltrating data before encryption (double extortion) |
| **Proxy HTTP_CONNECT** | Upload | Data exfiltration to attacker-controlled infrastructure |

---

## Detection Rule Logic (Reference)

```
# Sysmon: Known Windows process names running from non-standard locations
MATCH sysmon_logs WHERE
  event_type = "ProcessCreate"
  AND (
    image MATCHES "*\Temp\svchost.exe" OR
    image MATCHES "*\AppData\*\svchost.exe" OR
    image MATCHES "*\Downloads\svchost.exe" OR
    image MATCHES "*\Temp\csrss.exe" OR
    image MATCHES "*\AppData\*\lsass.exe"
  )
  AND image NOT STARTS WITH "C:\Windows\System32\"

# Sysmon: Mass file creation with encryption extensions
MATCH sysmon_logs WHERE
  event_type = "FileCreate"
  AND (
    target_filename MATCHES "*.locked" OR
    target_filename MATCHES "*.encrypted" OR
    target_filename MATCHES "*.crypt" OR
    target_filename MATCHES "*.enc" OR
    target_filename MATCHES "*.ransom"
  )
  AND COUNT(target_filename) > 10 WITHIN 60s
  GROUP BY host

# Sysmon: Ransom note creation
MATCH sysmon_logs WHERE
  event_type = "FileCreate"
  AND (
    target_filename MATCHES "*DECRYPT*" OR
    target_filename MATCHES "*RECOVER*" OR
    target_filename MATCHES "*RESTORE*" OR
    target_filename MATCHES "*README*RANSOM*" OR
    target_filename MATCHES "*HOW_TO*"
  )

# Correlation: Full ransomware chain
MATCH sysmon_logs AS process
  JOIN sysmon_logs AS encrypt
    ON process.host = encrypt.host
    AND process.process_id = encrypt.process_id
    AND encrypt.event_type = "FileCreate"
    AND encrypt.target_filename MATCHES "*.locked"
    AND encrypt.timestamp BETWEEN process.timestamp AND process.timestamp + 120s
  JOIN sysmon_logs AS ransom_note
    ON encrypt.host = ransom_note.host
    AND encrypt.process_id = ransom_note.process_id
    AND ransom_note.event_type = "FileCreate"
    AND ransom_note.target_filename MATCHES "*DECRYPT*"
    AND ransom_note.timestamp BETWEEN encrypt.timestamp AND encrypt.timestamp + 60s
WHERE
  process.event_type = "ProcessCreate"
  AND process.image NOT STARTS WITH "C:\Windows\"
```

---

## Common False Positives

Understanding legitimate scenarios helps avoid alert fatigue:

| False Positive Scenario | How to Identify |
|-------------------------|-----------------|
| Legitimate encryption software (BitLocker, VeraCrypt) | Runs from standard install paths, initiated by system processes or known IT tools |
| File sync tools renaming files temporarily | Known process (OneDrive, Dropbox), consistent daily pattern, files return to normal |
| Backup software creating compressed archives | Service account, scheduled task, files written to backup location not user Desktop |
| IT-deployed disk encryption rollout | Deployed via SCCM/Intune, parent process is management agent, documented change |
| Developer build tools creating output files | Known build process, files created in project output directories, standard extensions |

**Key Differentiators:**
- Legitimate: Standard install path, system/service account, scheduled/automated, known tool, no ransom note
- Malicious: Temp/AppData path, user account context, masquerading name, encryption flags in command line, ransom note on Desktop, rapid mass file modification

---

## Process Chain Analysis

### Suspicious Chain (This Scenario)
```
[{hostname}] powershell.exe (scripted payload delivery)
  └── svchost.exe (RANSOMWARE — from AppData\Local\Temp\)
      ├── Encrypts: Documents\ACME_Client_Contracts_2026.pdf → .pdf.locked
      ├── Encrypts: (hundreds of other files in Documents folder)
      └── Drops: Desktop\DECRYPT_YOUR_FILES.txt
          └── Attack complete — files locked, ransom demanded
```
**Why Suspicious:** svchost.exe in Temp, launched by PowerShell, encryption command-line flags, mass .locked file creation, ransom note on Desktop

### Legitimate Chain (Real svchost.exe)
```
[{hostname}] services.exe (Windows Service Control Manager)
  └── svchost.exe (LEGITIMATE — from C:\Windows\System32\)
      ├── Hosts: Windows Update service
      ├── Hosts: DNS Client service
      └── Hosts: DHCP Client service
          └── Normal Windows operations
```
**Why Legitimate:** Correct path (System32), correct parent (services.exe), standard service-hosting arguments (`-k netsvcs`), runs as SYSTEM account

---

*Last Updated: February 2026*  
*Spectyr Training Platform*
